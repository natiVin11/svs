<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×œ×•×— ×©× ×” - ×¢×•×¨×š ×“×™×Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: 'Arial', sans-serif; direction: rtl; text-align: center; background: linear-gradient(135deg, #e3f2fd, #bbdefb); margin: 0; padding: 0; }
    h1 { background: #007bff; color: white; padding: 20px; margin: 0; font-size: 24px; }
    #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); z-index: 1000; }
    #close-modal { position: absolute; top: 10px; left: 10px; cursor: pointer; font-size: 20px; color: red; }
    #calendar { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; }
    .holiday { background-color: rgba(255, 0, 0, 0.2) !important; color: red; font-weight: bold; }
    #add-meeting-btn { margin-top: 20px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
<h1>×œ×•×— ×©× ×” - ×¢×•×¨×š ×“×™×Ÿ</h1>

<button id="add-meeting-btn">â• ×”×•×¡×£ ×¤×’×™×©×”</button>

<div id="modal">
  <span id="close-modal">âŒ</span>
  <h2>ğŸ“ ×”×•×¡×£/×¢×¨×•×š ×¤×’×™×©×”</h2>
  <label>×©× ××œ×: <input type="text" id="full-name"></label><br>
  <label>×˜×œ×¤×•×Ÿ: <input type="text" id="phone"></label><br>
  <label>×’×•×©: <input type="text" id="gush"></label><br>
  <label>×—×œ×§×”: <input type="text" id="cheleka"></label><br>
  <label>×ª×ª ×—×œ×§×”: <input type="text" id="sub-cheleka"></label><br>
  <label>××™×™×œ: <input type="email" id="email"></label><br>
  <label>×ª××¨×™×š ×•×©×¢×”: <input type="datetime-local" id="datetime"></label><br>
  <button onclick="saveMeeting()">âœ… ×©××•×¨</button>
</div>

<div id="calendar"></div>

<script>
  let meetings = [];
  let holidays = [];
  let calendar;
  let editingMeeting = null;  // ××©×ª× ×” ×œ××—×¡×•×Ÿ ×¤×’×™×©×” ×œ×¢×¨×™×›×”

  async function fetchMeetings() {
    try {
      const response = await fetch("http://localhost:3100/newP.json");
      meetings = response.ok ? await response.json() : [];
    } catch (error) {
      console.error("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×’×™×©×•×ª:", error);
    }
  }

  async function fetchHolidays() {
    try {
      const response = await fetch("/holidays");
      if (!response.ok) {
        console.error("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×—×’×™×: ×”×ª×’×•×‘×” ×œ× ×ª×§×™× ×”");
        return [];  // ×× ×”×ª×’×•×‘×” ×œ× ×ª×§×™× ×”, × ×—×–×™×¨ ××¢×¨×š ×¨×™×§
      }
      const data = await response.json();
      return Array.isArray(data.holidays) ? data.holidays : [];  // ×œ×•×•×“× ×©×”× ×ª×•× ×™× ××›×™×œ×™× ××ª ×”×—×’×™×
    } catch (error) {
      console.error("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×—×’×™×:", error);
      return [];  // ×‘××§×¨×” ×©×œ ×©×’×™××”, × ×—×–×™×¨ ××¢×¨×š ×¨×™×§
    }
  }

  async function renderCalendar() {
    await fetchMeetings();
    holidays = await fetchHolidays();

    let calendarEl = document.getElementById("calendar");
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "he",
      selectable: true,
      events: [
        ...meetings,
        ...holidays.flatMap(h => {
          const startDate = new Date(h.start);
          const endDate = new Date(h.end);
          const events = [];
          // ×¢×‘×•×¨ ×›×œ ×—×’ ×¢× ×˜×•×•×— ×ª××¨×™×›×™×
          let currentDate = new Date(startDate);
          while (currentDate <= endDate) {
            events.push({
              title: h.name || "×—×’",  // ×× ××™×Ÿ ×©× ×œ×—×’, × ×©×ª××© ×‘" ×—×’"
              start: currentDate.toISOString().split('T')[0],  // ×”×ª××¨×™×š ×©×œ ×”×—×’
              className: 'holiday'
            });
            currentDate.setDate(currentDate.getDate() + 1);  // ×¢×‘×•×¨ ×œ×ª××¨×™×š ×”×‘× ×‘×˜×•×•×—
          }
          return events;
        })
      ],
      dateClick: function(info) {
        const isHoliday = holidays.some(h => {
          const start = new Date(h.start);
          const end = new Date(h.end);
          const selectedDate = new Date(info.dateStr);
          return selectedDate >= start && selectedDate <= end;
        });

        if (isHoliday) {
          alert("×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×¤×’×™×©×” ×‘×ª××¨×™×š ×–×”, ×–×”×• ×—×’.");
          return;
        }
        document.getElementById("datetime").value = info.dateStr + "T09:00";
        document.getElementById("modal").style.display = "block";
        editingMeeting = null;  // ×‘×™×˜×•×œ ×¢×¨×™×›×ª ×¤×’×™×©×” ×™×©× ×”
      },
      eventClick: function(info) {
        const meeting = info.event;
        const eventData = meeting.extendedProps;

        // ×”×¦×’×ª ×”××™×“×¢ ×‘×¤×•×¤××¤ ×œ×¢×¨×™×›×”
        document.getElementById("full-name").value = eventData.title.split(' - ')[0];
        document.getElementById("phone").value = eventData.phone;
        document.getElementById("gush").value = eventData.gush;
        document.getElementById("cheleka").value = eventData.cheleka;
        document.getElementById("sub-cheleka").value = eventData.subCheleka;
        document.getElementById("email").value = eventData.email;
        document.getElementById("datetime").value = meeting.startStr;

        // ×©×™× ×•×™ ××¦×‘ ×œ×¢×¨×™×›×ª ×¤×’×™×©×”
        editingMeeting = meeting;
        document.getElementById("modal").style.display = "block";
      }
    });
    calendar.render();
  }

  async function saveMeetingsToFile() {
    try {
      const response = await fetch("http://localhost:3100/save-meetings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(meetings)
      });
      if (!response.ok) throw new Error("âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×¤×’×™×©×•×ª");
      console.log("âœ… ×”×¤×’×™×©×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”");
    } catch (error) {
      console.error("âŒ ×©×’×™××” ×‘×©××™×¨×ª ×”×¤×’×™×©×•×ª:", error);
    }
  }

  function saveMeeting() {
    let fullName = document.getElementById("full-name").value;
    let phone = document.getElementById("phone").value;
    let gush = document.getElementById("gush").value;
    let cheleka = document.getElementById("cheleka").value;
    let subCheleka = document.getElementById("sub-cheleka").value;
    let email = document.getElementById("email").value;
    let datetime = document.getElementById("datetime").value;

    // ×‘×“×™×§×” ×× ×”×ª××¨×™×š × ×•×¤×œ ×¢×œ ×—×’
    const isHoliday = holidays.some(h => {
      const start = new Date(h.start);
      const end = new Date(h.end);
      const selectedDate = new Date(datetime);
      return selectedDate >= start && selectedDate <= end;
    });

    if (isHoliday) {
      alert("×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×¤×’×™×©×” ×‘×ª××¨×™×š ×–×”, ×–×”×• ×—×’.");
      return;
    }

    // ×‘×“×™×§×” ×× ×”×¤×’×™×©×” ×”×™× ×œ×¤× ×™ 9:00 ××• ××—×¨×™ 20:00
    const selectedTime = new Date(datetime);
    if (selectedTime.getHours() < 9 || selectedTime.getHours() > 20) {
      alert("×œ× × ×™×ª×Ÿ ×œ×§×‘×•×¢ ×¤×’×™×©×” ×œ×¤× ×™ 9:00 ××• ××—×¨×™ 20:00");
      return;
    }

    // ×‘×“×™×§×” ×× ×”×¤×’×™×©×” ×§×¨×•×‘×” ××“×™ ×œ×¤×’×™×©×” ×§×•×“××ª
    const lastMeeting = meetings[meetings.length - 1];
    if (lastMeeting && new Date(datetime) - new Date(lastMeeting.start) < 30 * 60 * 1000) {
      alert("×”×¤×’×™×©×” ×¦×¨×™×›×” ×œ×”×™×•×ª ×œ×¤×—×•×ª ×—×¦×™ ×©×¢×” ××”×¤×’×™×©×” ×”×§×•×“××ª");
      return;
    }

    const meetingData = {
      title: fullName + " - ×¤×’×™×©×”",
      start: datetime,
      description: `×˜×œ×¤×•×Ÿ: ${phone}, ×’×•×©: ${gush}, ×—×œ×§×”: ${cheleka}, ×ª×ª ×—×œ×§×”: ${subCheleka}, ××™×™×œ: ${email}`,
      phone,
      gush,
      cheleka,
      subCheleka,
      email
    };

    if (editingMeeting) {
      // ×× ××“×•×‘×¨ ×‘×¢×¨×™×›×”, × ×¢×“×›×Ÿ ××ª ×”×¤×’×™×©×” ×”×§×™×™××ª
      editingMeeting.setProp('title', fullName + " - ×¤×’×™×©×”");
      editingMeeting.setStart(datetime);
      editingMeeting.setExtendedProp('phone', phone);
      editingMeeting.setExtendedProp('gush', gush);
      editingMeeting.setExtendedProp('cheleka', cheleka);
      editingMeeting.setExtendedProp('subCheleka', subCheleka);
      editingMeeting.setExtendedProp('email', email);
      editingMeeting.setExtendedProp('description', `×˜×œ×¤×•×Ÿ: ${phone}, ×’×•×©: ${gush}, ×—×œ×§×”: ${cheleka}, ×ª×ª ×—×œ×§×”: ${subCheleka}, ××™×™×œ: ${email}`);
    } else {
      // ×× ××“×•×‘×¨ ×‘×”×•×¡×¤×” ×—×“×©×”, × ×™×¦×•×¨ ×¤×’×™×©×” ×—×“×©×”
      meetings.push(meetingData);
      calendar.addEvent(meetingData);
    }

    saveMeetingsToFile();
    document.getElementById("modal").style.display = "none";
  }

  // ×¡×’×™×¨×ª ×—×œ×•×Ÿ ×”×¤×•×¤××¤
  document.getElementById("close-modal").addEventListener("click", () => {
    document.getElementById("modal").style.display = "none";
  });

  // ××ª×—×•×œ ×”×œ×•×— ×©× ×”
  renderCalendar();
</script>
</body>
</html>
